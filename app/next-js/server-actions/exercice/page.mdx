# 📌 **Exercice : Server Actions & Optimistic UI**  

**1️⃣ Objectif**  
- Implémenter un **formulaire de contact** avec une **Server Action**.  
- Créer un bouton **"Like"** avec une mise à jour **optimiste** et en temps réel.  

---

## **📝 Exercice 1 : Formulaire de contact avec une Server Action**  

### **📌 Étape 1 : Création de la Server Action**  

```tsx filename="app/actions/contact.ts" copy
"use server";

import { revalidatePath } from "next/cache";

export async function sendContactMessage(formData: FormData) {
  const name = formData.get("name") as string;
  const email = formData.get("email") as string;
  const message = formData.get("message") as string;

  if (!name || !email || !message) {
    return { error: "Tous les champs sont requis" };
  }

  await new Promise((resolve) => setTimeout(resolve, 1000)); // Simule un délai réseau

  console.log("Message reçu :", { name, email, message });

  revalidatePath("/contact"); // Facultatif si on veut recharger la page

  return { success: "Message envoyé !" };
}
```

✅ **Explication** :  
- La fonction récupère les données du formulaire et simule un envoi.  
- Elle **attend 1 seconde** (simule une requête distante).  
- Elle renvoie un **message de succès** ou une **erreur**.  

---

### **📌 Étape 2 : Création du formulaire côté client**  

```tsx filename="app/contact/page.tsx" copy
"use client";

import { useState, useTransition } from "react";
import { sendContactMessage } from "@/app/actions/contact";

export default function ContactPage() {
  const [message, setMessage] = useState("");
  const [isPending, startTransition] = useTransition();

  async function handleSubmit(event: React.FormEvent<HTMLFormElement>) {
    event.preventDefault();
    
    const formData = new FormData(event.currentTarget);
    
    startTransition(async () => {
      const result = await sendContactMessage(formData);
      if (result?.success) {
        setMessage(result.success);
        event.currentTarget.reset(); // Réinitialisation du formulaire
      } else {
        setMessage(result.error);
      }
    });
  }

  return (
    <div className="max-w-lg mx-auto p-6 border rounded-lg shadow-lg">
      <h1 className="text-xl font-bold mb-4">Contactez-nous</h1>
      <form onSubmit={handleSubmit} className="space-y-3">
        <input name="name" placeholder="Nom" required className="w-full p-2 border rounded" />
        <input type="email" name="email" placeholder="Email" required className="w-full p-2 border rounded" />
        <textarea name="message" placeholder="Votre message" required className="w-full p-2 border rounded"></textarea>
        <button 
          type="submit" 
          disabled={isPending} 
          className={`w-full py-2 rounded ${isPending ? "bg-gray-400" : "bg-blue-500 text-white"}`}
        >
          {isPending ? "Envoi..." : "Envoyer"}
        </button>
      </form>
      {message && <p className="mt-2 text-center text-green-500">{message}</p>}
    </div>
  );
}
```

✅ **Explication** :  
- Utilisation de `useTransition()` pour empêcher le blocage de l’UI.  
- **Affichage d’un message de succès** ou d’erreur.  
- **Réinitialisation du formulaire** après l’envoi.  

---

## **📝 Exercice 2 : Bouton "Like" avec mise à jour optimiste**  

### **📌 Étape 1 : Création de la Server Action**  

```tsx filename="app/actions/likes.ts" copy
"use server";

import { revalidatePath } from "next/cache";

let likes = 0; // Simule un compteur en mémoire (à remplacer par une DB)

export async function addLike() {
  likes++;

  await new Promise((resolve) => setTimeout(resolve, 500)); // Simule une requête

  revalidatePath("/likes");
  return likes;
}
```

✅ **Explication** :  
- On simule un compteur `likes`.  
- Il est **incrémenté** et la page est **revalidée** après 500ms.  

---

### **📌 Étape 2 : Interface avec mise à jour optimiste**  

```tsx filename="app/likes/page.tsx"
"use client";

import { useOptimistic, useTransition, useState } from "react";
import { addLike } from "@/app/actions/likes";

export default function LikeButton() {
  const [likes, setLikes] = useState(0);
  const [isPending, startTransition] = useTransition();

  // Gestion optimiste des likes
  const [optimisticLikes, setOptimisticLikes] = useOptimistic(
    likes,
    (currentLikes) => currentLikes + 1
  );

  function handleLike() {
    setOptimisticLikes(); // Ajout immédiat en UI
    
    startTransition(async () => {
      const updatedLikes = await addLike();
      setLikes(updatedLikes);
    });
  }

  return (
    <div className="flex flex-col items-center p-6 border rounded-lg shadow-lg">
      <button 
        onClick={handleLike}
        disabled={isPending}
        className={`px-4 py-2 rounded ${isPending ? "bg-gray-400" : "bg-red-500 text-white"}`}
      >
        ❤️ Like ({optimisticLikes})
      </button>
    </div>
  );
}
```

✅ **Explication** :  
- **Optimistic UI** : Le like **est affiché instantanément** en UI.  
- `useTransition()` empêche le **blocage du bouton** pendant la requête.  
- Une fois l’action complétée, **l’état réel est mis à jour**.  

---

## **🎯 Conclusion**  

🚀 **Avec ces exercices, vous maîtrisez** :  
✅ **Les Server Actions** pour soumettre et récupérer des données.  
✅ **`useTransition()`** pour une UI **fluide et réactive**.  
✅ **`useOptimistic()`** pour une mise à jour **instantanée et sans latence**.