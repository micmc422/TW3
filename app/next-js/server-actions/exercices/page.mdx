# üìå **Travail Pratique : Server Actions & Optimistic UI avec Next.js 14+**

## ‚ö° **Objectifs**
1. Impl√©menter un **formulaire de contact** utilisant une **Server Action** pour envoyer des donn√©es sans passer par un appel `fetch()` explicite.
2. Cr√©er un bouton **"Like"** qui met √† jour instantan√©ment l'affichage (optimistic UI) gr√¢ce √† `useOptimistic()` et `useTransition()`.

> **Note :** Dans Next.js 14+, les Server Actions permettent d‚Äôattacher directement une fonction serveur √† l'attribut `action` d‚Äôun formulaire. Assurez-vous que les fichiers respectent la convention ¬´‚ÄØ`"use server";` en t√™te de fichier d‚Äôaction‚ÄØ¬ª.

üîó **Code source :** [üìÇ GitHub](https://github.com/micmc422/my-next-app.git) üöÄ

---

## üìù **Exercice 1 : Formulaire de contact avec Server Action**

### ‚ö° **√âtape 1 : Cr√©er la Server Action**

Cr√©ez un fichier `app/contact/contact.ts` qui contient la fonction serveur suivante :

```tsx filename="app/contact/contact.ts" copy
"use server";

import { revalidatePath } from "next/cache";

export async function sendContactMessage(formData: FormData) {
  // R√©cup√©ration et validation des donn√©es
  const name = formData.get("name") as string;
  const email = formData.get("email") as string;
  const message = formData.get("message") as string;

  if (!name || !email || !message) {
    return { error: "Tous les champs sont requis." };
  }

  // Simulation d'un d√©lai r√©seau (1 seconde)
  await new Promise((resolve) => setTimeout(resolve, 1000));

  // Log en console c√¥t√© serveur (pour la d√©mo)
  console.log("Message re√ßu :", { name, email, message });

  // Optionnel : invalider le cache de la page /contact pour rafra√Æchir les donn√©es
  revalidatePath("/contact");

  return { success: "Message envoy√© !" };
}
```

> **Explication :**  
> - La directive `"use server";` garantit que cette fonction s'ex√©cute uniquement c√¥t√© serveur.  
> - La fonction r√©cup√®re les champs du formulaire, effectue une validation simple et simule un d√©lai.  
> - En cas de succ√®s, elle renvoie un objet avec une propri√©t√© `success`, sinon une propri√©t√© `error`.

---

### ‚ö° **√âtape 2 : Cr√©er le formulaire c√¥t√© client**

Cr√©ez ou modifiez le fichier `app/contact/page.tsx` pour utiliser la Server Action directement via l'attribut `action` du formulaire. Comme l'interactivit√© est g√©r√©e c√¥t√© client (affichage des messages, gestion de l'√©tat), le composant doit √™tre un Client Component (d√©clar√© avec `"use client"`).

```tsx filename="app/contact/page.tsx" copy
"use client";

import { useState, useTransition } from "react";
import { sendContactMessage } from "@/app/contact/contact";
import { useRouter } from "next/navigation";

export default function ContactPage() {
    const [feedback, setFeedback] = useState<string | null | undefined>(null);
    const [isPending, startTransition] = useTransition();
    const router = useRouter()

    // Nous utilisons la Server Action directement dans le formulaire.
    // Next.js 14+ g√®re automatiquement la conversion du FormData en appel serveur.
    async function handleSubmit(event: React.FormEvent<HTMLFormElement>) {
        event.preventDefault();

        // D√©marrer la transition pour √©viter de bloquer l'UI
        startTransition(async () => {
            // Appel direct de la Server Action via l'attribut "action"
            const result = await sendContactMessage(new FormData(event.currentTarget));
            if (result?.success) {
                setFeedback(result.success);
                router.refresh();
            } else {
                setFeedback(result.error);
            }
        });
    }

    return (
        <div className="max-w-lg mx-auto p-6 border rounded-lg shadow-lg">
            <h1 className="text-xl font-bold mb-4">Contactez-nous</h1>
            <form onSubmit={handleSubmit} className="space-y-3">
                <input
                    name="name"
                    placeholder="Nom"
                    required
                    className="w-full p-2 border rounded"
                />
                <input
                    type="email"
                    name="email"
                    placeholder="Email"
                    required
                    className="w-full p-2 border rounded"
                />
                <textarea
                    name="message"
                    placeholder="Votre message"
                    required
                    className="w-full p-2 border rounded"
                />
                <button
                    type="submit"
                    disabled={isPending}
                    className={`w-full py-2 rounded ${isPending ? "bg-gray-400" : "bg-blue-500 text-white"
                        }`}
                >
                    {isPending ? "Envoi en cours..." : "Envoyer"}
                </button>
            </form>
            {feedback && <p className="mt-2 text-center text-green-500">{feedback}</p>}
        </div>
    );
}
```

> **Explication :**  
> - Le hook `useTransition()` permet de lancer la fonction sans bloquer l'interface.  
> - L'√©tat `feedback` affiche un message de succ√®s ou d'erreur apr√®s l'envoi.

---

## üìù **Exercice 2 : Bouton "Like" avec mise √† jour optimiste**

### ‚ö° **√âtape 1 : Cr√©er la Server Action pour incr√©menter le compteur**

Cr√©ez le fichier `app/likes/likes.ts` :

```tsx filename="app/likes/likes.ts" copy
"use server";

import { revalidatePath } from "next/cache";

// Simuler un compteur stock√© en m√©moire (√† remplacer par une DB dans une vraie application)
let likeCount = 0;

export async function addLike() {
  likeCount++;

  // Simuler un d√©lai de traitement (500 ms)
  await new Promise((resolve) => setTimeout(resolve, 500));

  // Optionnel : invalider la page /likes pour rafra√Æchir le contenu
  revalidatePath("/likes");

  return likeCount;
}
```

> **Explication :**  
> - La fonction incr√©mente une variable `likeCount` et simule un d√©lai.  
> - Elle renvoie le nouveau nombre de likes apr√®s mise √† jour.

---

### ‚ö° **√âtape 2 : Cr√©er l'interface du bouton Like avec mise √† jour optimiste**

Cr√©ez ou modifiez le fichier `app/likes/page.tsx` :

```tsx filename="app/likes/page.tsx" copy
"use client";

import { useState, useTransition, useOptimistic } from "react";
import { addLike } from "@/app/likes/likes";

export default function LikeButton() {
    const [likes, setLikes] = useState(0);
    const [isPending, startTransition] = useTransition();

    // Utilisation de useOptimistic pour mettre √† jour imm√©diatement le compteur
    const [optimisticLikes, setOptimisticLikes] = useOptimistic(likes, (current) => current + 1);

    function handleLike() {

        // Lancer la Server Action dans une transition pour √©viter le blocage de l'UI
        startTransition(async () => {
        // Mise √† jour optimiste imm√©diate
        setOptimisticLikes(likes);
            const updatedLikes = await addLike();
            setLikes(updatedLikes); // Met √† jour l'√©tat r√©el une fois la r√©ponse obtenue
        });
    }

    return (
        <div className="flex flex-col items-center p-6 border rounded-lg shadow-lg">
            <button
                onClick={handleLike}
                disabled={isPending}
                className={`px-4 py-2 rounded ${isPending ? "bg-gray-400" : "bg-red-500 text-white"}`}
            >
                ‚ù§Ô∏è Like ({optimisticLikes})
            </button>
        </div>
    );
}
```

> **Explication :**  
> - Le hook `useOptimistic()` permet d'afficher imm√©diatement l'incr√©mentation du compteur, am√©liorant ainsi la r√©activit√© (optimistic UI).  
> - `useTransition()` garantit que l'appel √† la Server Action ne bloque pas l'interface.  
> - Une fois la Server Action ex√©cut√©e, l'√©tat r√©el (`likes`) est mis √† jour.

---

## üéØ **Conclusion**

Avec cet exercice, vous avez appris √† :
- Utiliser les **Server Actions** de Next.js 14+ pour g√©rer des formulaires sans recourir √† un appel `fetch()` explicite.
- Mettre en place une **optimistic UI** avec `useOptimistic()` et `useTransition()`, garantissant ainsi une exp√©rience utilisateur fluide et r√©active.

N'oubliez pas de tester vos impl√©mentations en local et de consulter la documentation officielle pour les derni√®res mises √† jour sur les Server Actions et les hooks exp√©rimentaux. Bonne pratique !