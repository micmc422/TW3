# üîë **Authentification avec NextAuth.js et gestion des sessions dans Next.js 13+**  

NextAuth.js est une solution d‚Äôauthentification **simple et s√©curis√©e** pour Next.js. Il prend en charge plusieurs fournisseurs (**OAuth, Credentials, JWT, etc.**) et s‚Äôint√®gre parfaitement avec l‚Äôarchitecture **App Router (`app/`)** de Next.js 13+.  

---

## **1Ô∏è‚É£ Installation de NextAuth.js**  

Avant de commencer, installons la biblioth√®que :  

```sh
npm install next-auth
```

---

## **2Ô∏è‚É£ Configuration de NextAuth.js avec un fournisseur (Google)**  

### **üìå D√©finition du routeur d‚Äôauthentification (`/app/api/auth/[...nextauth]/route.ts`)**  

NextAuth.js fonctionne via une API route qui g√®re l‚Äôauthentification.  

```tsx filename="app/api/auth/[...nextauth]/route.ts" copy
import NextAuth from "next-auth";
import GoogleProvider from "next-auth/providers/google";

export const authOptions = {
  providers: [
    GoogleProvider({
      clientId: process.env.GOOGLE_CLIENT_ID!,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
    }),
  ],
  secret: process.env.NEXTAUTH_SECRET, // Cl√© secr√®te pour s√©curiser les sessions
  callbacks: {
    async session({ session, token }) {
      session.user.id = token.sub; // Ajout de l'ID utilisateur √† la session
      return session;
    },
  },
};

const handler = NextAuth(authOptions);
export { handler as GET, handler as POST };
```

‚úÖ **Explication** :  
- D√©clare **Google** comme fournisseur OAuth.  
- Utilise `callbacks.session` pour stocker l'ID utilisateur dans la session.  
- D√©finit l'API route `auth/` qui g√®re la connexion et la d√©connexion.  

---

## **3Ô∏è‚É£ Ajout des variables d‚Äôenvironnement (`.env.local`)**  

Cr√©ez un fichier `.env.local` √† la racine du projet et ajoutez :  

```env
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret
NEXTAUTH_SECRET=your-random-secret-key
NEXTAUTH_URL=http://localhost:3000
```

Remplacez `your-google-client-id` et `your-google-client-secret` par vos cl√©s Google OAuth (disponibles dans [Google Cloud Console](https://console.cloud.google.com/)).  

---

## **4Ô∏è‚É£ Interface utilisateur : Connexion & D√©connexion**  

Maintenant, cr√©ons un bouton de connexion/d√©connexion pour g√©rer les sessions.  

```tsx filename="components/AuthButton.tsx"
"use client";

import { signIn, signOut, useSession } from "next-auth/react";

export default function AuthButton() {
  const { data: session } = useSession();

  if (session) {
    return (
      <div>
        <p>Connect√© en tant que {session.user?.email}</p>
        <button onClick={() => signOut()} className="bg-red-500 text-white px-4 py-2 rounded">
          Se d√©connecter
        </button>
      </div>
    );
  }

  return (
    <button onClick={() => signIn("google")} className="bg-blue-500 text-white px-4 py-2 rounded">
      Se connecter avec Google
    </button>
  );
}
```

‚úÖ **Explication** :  
- **`useSession()`** : R√©cup√®re l‚Äô√©tat de l‚Äôutilisateur connect√©.  
- **`signIn("google")`** : D√©marre l‚Äôauthentification avec Google.  
- **`signOut()`** : D√©connecte l‚Äôutilisateur.  

---

## **5Ô∏è‚É£ Protection des pages (Middleware & Server Components)**  

### **üîπ Middleware : Prot√©ger l‚Äôensemble du site**  
Si vous voulez restreindre l‚Äôacc√®s aux pages aux utilisateurs connect√©s, utilisez un **middleware**.  

üõ† **Fichier : `middleware.ts`**  
```ts filename="middleware.ts" copy
import { withAuth } from "next-auth/middleware";

export default withAuth({
  pages: {
    signIn: "/login", // Redirection si l'utilisateur n'est pas authentifi√©
  },
});
```

Ce middleware emp√™che les utilisateurs non authentifi√©s d‚Äôacc√©der √† certaines pages.  

### **üîπ Protection des pages avec Server Components**  
Vous pouvez √©galement prot√©ger une page sp√©cifique en r√©cup√©rant la session c√¥t√© serveur.  

```tsx filename="app/dashboard/page.tsx"
import { getServerSession } from "next-auth";
import { authOptions } from "../api/auth/[...nextauth]/route";

export default async function Dashboard() {
  const session = await getServerSession(authOptions);

  if (!session) {
    return <p>Acc√®s refus√©. Veuillez vous connecter.</p>;
  }

  return <h1>Bienvenue sur le Dashboard, {session.user?.name} !</h1>;
}
```

‚úÖ **Explication** :  
- **`getServerSession(authOptions)`** r√©cup√®re la session c√¥t√© serveur.  
- Si l‚Äôutilisateur n‚Äôest pas connect√©, un message d‚Äôerreur s‚Äôaffiche.  

---

## **6Ô∏è‚É£ G√©rer la session dans un Layout global**  

Vous pouvez afficher l‚Äô√©tat de l‚Äôauthentification dans un **layout** global.  

```tsx filename="app/layout.tsx"
import { getServerSession } from "next-auth";
import { authOptions } from "./api/auth/[...nextauth]/route";
import AuthButton from "@/components/AuthButton";

export default async function RootLayout({ children }) {
  const session = await getServerSession(authOptions);

  return (
    <html lang="fr">
      <body>
        <nav>
          {session ? (
            <p>Bienvenue, {session.user?.name}!</p>
          ) : (
            <p>Vous n'√™tes pas connect√©.</p>
          )}
          <AuthButton />
        </nav>
        {children}
      </body>
    </html>
  );
}
```

‚úÖ **Avantage** : La session est accessible partout dans l‚Äôapplication.  

---

## **üéØ Conclusion**  

üöÄ Avec **NextAuth.js**, l‚Äôauthentification dans Next.js 13+ devient **simple et s√©curis√©e** :  
‚úÖ Gestion native des sessions avec **`useSession()`** et **`getServerSession()`**.  
‚úÖ Support de plusieurs fournisseurs OAuth (Google, GitHub, etc.).  
‚úÖ S√©curit√© renforc√©e avec **JWT et cookies s√©curis√©s**.  

üìå **Prochaine √©tape ?** Ajouter une base de donn√©es pour g√©rer les utilisateurs avec **Prisma** ! üî•